<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="Harry Zheng" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Kubernetes, CI/CD, Kubernetes, " />

<meta property="og:title" content="Kubernetes Stateful Application "/>
<meta property="og:url" content="./kubernetes-stateful-application.html" />
<meta property="og:description" content="Deploy a Kubernetes stateful application" />
<meta property="og:site_name" content="Coding Digests" />
<meta property="og:article:author" content="Harry Zheng" />
<meta property="og:article:published_time" content="2019-03-14T00:00:00-07:00" />
<meta property="og:article:modified_time" content="2019-03-15T00:00:00-07:00" />
<meta name="twitter:title" content="Kubernetes Stateful Application ">
<meta name="twitter:description" content="Deploy a Kubernetes stateful application">

        <title>Kubernetes Stateful Application  Â· Coding Digests
</title>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-137819228-1', 'auto');
    ga('send', 'pageview');
</script>



        <style>
            body {
                padding-top: 60px;
            }
        </style>
    </head>
    <body>
        <div id="content">
            <nav class="navbar navbar-default navbar-fixed-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>Coding Digests</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/contact.html">Contact</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="./kubernetes-stateful-application.html">
                Kubernetes Stateful Application
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>This article is a summary of the <a href="https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/">tutorial</a>. It utilizes manifest file to create deployments and services. </p>
<p>Most of the time, we need to have persistent data saved at a location and when the service is restarted, the data was saved and can be loaded to restore its latest state. This is achived through stateful application in Kubernetes. </p>
<h2>Objective</h2>
<p>This tutorial covers basic steps deploy a simple web application using <code>StatefulSet</code>. The website is served in a html file by nginx. </p>
<ol>
<li>Create a StatefulSet</li>
<li>Manage Pods through StatefulSet</li>
<li>Delete a StatefulSet</li>
<li>Scale a StatefulSet</li>
<li>Update a StatefulSet's Pods</li>
</ol>
<h2>Creating a StatefulSet</h2>
<p>Using the <code>yaml</code> file below, we create a headless service, <code>nginx</code>, to publish the IP addresses of Pods in the StatefulSet, <code>web</code>. The manifest file <code>web.yaml</code>. </p>
<div class="highlight"><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">ports</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">port</span><span class="o">:</span> <span class="mi">80</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
  <span class="n">clusterIP</span><span class="o">:</span> <span class="n">None</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
<span class="o">---</span>
<span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">StatefulSet</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">serviceName</span><span class="o">:</span> <span class="s2">&quot;nginx&quot;</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">k8s</span><span class="o">.</span><span class="na">gcr</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">slim</span><span class="o">:</span><span class="mf">0.8</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">www</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/usr/share/nginx/</span><span class="n">html</span>
  <span class="n">volumeClaimTemplates</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">metadata</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">www</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">accessModes</span><span class="o">:</span> <span class="o">[</span> <span class="s2">&quot;ReadWriteOnce&quot;</span> <span class="o">]</span>
      <span class="n">resources</span><span class="o">:</span>
        <span class="n">requests</span><span class="o">:</span>
          <span class="n">storage</span><span class="o">:</span> <span class="mi">1</span><span class="n">Gi</span>
</code></pre></div>


<p>In this tutorial, we will use two terminal windows. One uses <code>kubectl get pods -w -l app=nginx</code> command to get live update from Kubernetes service about the status of our pods. The other terminal window is used to execute command the deploy, update and delete Pods and StatefulSets. </p>
<p>In the first terminal window execiute this command to watch the creation of the StatefulSet's Pods. </p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl get pods -w -l app=nginx</span>
</code></pre></div>


<p>In the second terminal, use <code>kubectl create</code> to create the headless Service and StatefulSet defined in <code>web.yaml</code>.</p>
<div class="highlight"><pre><span></span><code>$ kubectl create -f web.yaml
service/nginx created
statefulset.apps/web created
</code></pre></div>


<p>Check the running service, </p>
<div class="highlight"><pre><span></span><code>$ kubectl get service nginx
NAME      TYPE         CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
nginx     ClusterIP    None         &lt;none&gt;        <span class="m">80</span>/TCP    12s
</code></pre></div>


<p>Check running statefulset</p>
<div class="highlight"><pre><span></span><code>$ kubectl get statefulset web
NAME      DESIRED   CURRENT   AGE
web       <span class="m">2</span>         <span class="m">1</span>         20s
</code></pre></div>


<p>On the first terminal, we should see the Pods being deployed in action. </p>
<div class="highlight"><pre><span></span><code>$ kubectl get pods -w -l <span class="nv">app</span><span class="o">=</span>nginx
NAME      READY     STATUS    RESTARTS   AGE
web-0     <span class="m">0</span>/1       Pending   <span class="m">0</span>          0s
web-0     <span class="m">0</span>/1       Pending   <span class="m">0</span>         0s
web-0     <span class="m">0</span>/1       ContainerCreating   <span class="m">0</span>         0s
web-0     <span class="m">1</span>/1       Running   <span class="m">0</span>         19s
web-1     <span class="m">0</span>/1       Pending   <span class="m">0</span>         0s
web-1     <span class="m">0</span>/1       Pending   <span class="m">0</span>         0s
web-1     <span class="m">0</span>/1       ContainerCreating   <span class="m">0</span>         0s
web-1     <span class="m">1</span>/1       Running   <span class="m">0</span>         18s
</code></pre></div>


<h2>Pods in a StatefulSet</h2>
<p>Pods in a StatefulSet have a unique ordinal index and a stable network identity.</p>
<h3>Examping the Pod's Ordinal Index</h3>
<p>Get the StatefulSetâs Pods.</p>
<div class="highlight"><pre><span></span><code>$ kubectl get pods -l <span class="nv">app</span><span class="o">=</span>nginx
NAME      READY     STATUS    RESTARTS   AGE
web-0     <span class="m">1</span>/1       Running   <span class="m">0</span>          1m
web-1     <span class="m">1</span>/1       Running   <span class="m">0</span>          1m
</code></pre></div>


<p>The Podsâ names take the form <code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code>. Since the web StatefulSet has two replicas, it creates two Pods, <code>web-0</code> and <code>web-1</code>.</p>
<p>Each Pod has a stable hostname based on its ordinal index. </p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">;</span> <span class="k">do</span> <span class="n">kubectl</span> <span class="k">exec</span> <span class="n">web</span><span class="o">-</span><span class="err">$</span><span class="n">i</span> <span class="c1">-- sh -c &#39;hostname&#39;; done</span>
<span class="n">web</span><span class="o">-</span><span class="mi">0</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>

<span class="n">kubectl</span> <span class="n">run</span> <span class="o">-</span><span class="n">i</span> <span class="c1">--tty --image busybox:1.28 dns-test --restart=Never --rm  </span>
<span class="n">nslookup</span> <span class="n">web</span><span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="n">nginx</span>
<span class="n">Server</span><span class="p">:</span>    <span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span>
<span class="n">Address</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span> <span class="n">kube</span><span class="o">-</span><span class="n">dns</span><span class="p">.</span><span class="n">kube</span><span class="o">-</span><span class="k">system</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">local</span>

<span class="n">Name</span><span class="p">:</span>      <span class="n">web</span><span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="n">nginx</span>
<span class="n">Address</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">244</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">6</span>

<span class="n">nslookup</span> <span class="n">web</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="n">nginx</span>
<span class="n">Server</span><span class="p">:</span>    <span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span>
<span class="n">Address</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span> <span class="n">kube</span><span class="o">-</span><span class="n">dns</span><span class="p">.</span><span class="n">kube</span><span class="o">-</span><span class="k">system</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">local</span>

<span class="n">Name</span><span class="p">:</span>      <span class="n">web</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="n">nginx</span>
<span class="n">Address</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">244</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">6</span>
</code></pre></div>


<h3>Manage Pods in StatefulSet</h3>
<p>In second terminal, use <code>kubectl delete</code> to delete all Pods in the StatefulSet. </p>
<div class="highlight"><pre><span></span><code>$ kubectl delete pod -l <span class="nv">app</span><span class="o">=</span>nginx
pod <span class="s2">&quot;web-0&quot;</span> deleted
pod <span class="s2">&quot;web-1&quot;</span> deleted
</code></pre></div>


<p>This will delete both pods but StatefulSet will restart then. The process is shown in the first terminal. </p>
<div class="highlight"><pre><span></span><code>$ kubectl get pod -w -l <span class="nv">app</span><span class="o">=</span>nginx
NAME      READY     STATUS              RESTARTS   AGE
web-0     <span class="m">0</span>/1       ContainerCreating   <span class="m">0</span>          0s
NAME      READY     STATUS    RESTARTS   AGE
web-0     <span class="m">1</span>/1       Running   <span class="m">0</span>          2s
web-1     <span class="m">0</span>/1       Pending   <span class="m">0</span>         0s
web-1     <span class="m">0</span>/1       Pending   <span class="m">0</span>         0s
web-1     <span class="m">0</span>/1       ContainerCreating   <span class="m">0</span>         0s
web-1     <span class="m">1</span>/1       Running   <span class="m">0</span>         34s
</code></pre></div>


<p>Try print out the hostname again, </p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">;</span> <span class="k">do</span> <span class="n">kubectl</span> <span class="k">exec</span> <span class="n">web</span><span class="o">-</span><span class="err">$</span><span class="n">i</span> <span class="c1">-- sh -c &#39;hostname&#39;; done</span>
<span class="n">web</span><span class="o">-</span><span class="mi">0</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>

<span class="n">kubectl</span> <span class="n">run</span> <span class="o">-</span><span class="n">i</span> <span class="c1">--tty --image busybox dns-test --restart=Never --rm /bin/sh </span>
<span class="n">nslookup</span> <span class="n">web</span><span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="n">nginx</span>
<span class="n">Server</span><span class="p">:</span>    <span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span>
<span class="n">Address</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span> <span class="n">kube</span><span class="o">-</span><span class="n">dns</span><span class="p">.</span><span class="n">kube</span><span class="o">-</span><span class="k">system</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">local</span>

<span class="n">Name</span><span class="p">:</span>      <span class="n">web</span><span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="n">nginx</span>
<span class="n">Address</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">244</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">7</span>

<span class="n">nslookup</span> <span class="n">web</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="n">nginx</span>
<span class="n">Server</span><span class="p">:</span>    <span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span>
<span class="n">Address</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span> <span class="n">kube</span><span class="o">-</span><span class="n">dns</span><span class="p">.</span><span class="n">kube</span><span class="o">-</span><span class="k">system</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">local</span>

<span class="n">Name</span><span class="p">:</span>      <span class="n">web</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="n">nginx</span>
<span class="n">Address</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">244</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">8</span>
</code></pre></div>


<p>The hostname persists, but IP addresses associated with the Pods maybe change. This is why it is important not to configure other applications to connect to Pods in a StatefulSet by IP address.</p>
<h3>Writing to stable storage</h3>
<p>We will be writing a text to the index page in the persistent volume. </p>
<p>Get the PersistentVolumeClaims for <code>web-0</code> and <code>web-1</code>.</p>
<div class="highlight"><pre><span></span><code>$ kubectl get pvc -l <span class="nv">app</span><span class="o">=</span>nginx
NAME        STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE
www-web-0   Bound     pvc-15c268c7-b507-11e6-932f-42010a800002   1Gi        RWO           48s
www-web-1   Bound     pvc-15c79307-b507-11e6-932f-42010a800002   1Gi   
</code></pre></div>


<p>The NGINX webservers, by default, will serve an index file at <code>/usr/share/nginx/html/index.html</code>. The <code>volumeMounts</code> field in the StatefulSets spec ensures that the <code>/usr/share/nginx/html</code>directory is backed by a PersistentVolume.
Write the Podsâ hostnames to their index.html files and verify that the NGINX webservers serve the hostnames.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">;</span> <span class="k">do</span> <span class="n">kubectl</span> <span class="k">exec</span> <span class="n">web</span><span class="o">-</span><span class="err">$</span><span class="n">i</span> <span class="c1">-- sh -c &#39;echo $(hostname) &gt; /usr/share/nginx/html/index.html&#39;; done</span>

<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">;</span> <span class="k">do</span> <span class="n">kubectl</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">web</span><span class="o">-</span><span class="err">$</span><span class="n">i</span> <span class="c1">-- curl localhost; done</span>
<span class="n">web</span><span class="o">-</span><span class="mi">0</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>
</code></pre></div>


<p>Now let's delete the Pods:</p>
<div class="highlight"><pre><span></span><code>$ kubectl delete pod -l <span class="nv">app</span><span class="o">=</span>nginx
pod <span class="s2">&quot;web-0&quot;</span> deleted
pod <span class="s2">&quot;web-1&quot;</span> deleted
</code></pre></div>


<p>StatefulSet will recreate these Pods and mount the same persistent volume onto them. Thus the changes we've written to <code>index.html</code> should still be there. </p>
<p>Check the <code>index.html</code> again, </p>
<div class="highlight"><pre><span></span><code><span class="err">for i in 0 1; do kubectl exec -it web-$i -- curl localhost; done</span>
<span class="err">web-0</span>
<span class="err">web-1</span>
</code></pre></div>


<h2>Scaling a StatefulSet</h2>
<h3>Scaling up</h3>
<p>In terminal 2, user <code>kubectl scale</code> to scale the number of replicas to 5. </p>
<div class="highlight"><pre><span></span><code>$ kubectl scale sts web --replicas<span class="o">=</span><span class="m">5</span>
statefulset.apps/web scaled
</code></pre></div>


<p>In terminal 1, this change should show up</p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl get pods -w -l app=nginx</span>
<span class="err">NAME      READY     STATUS    RESTARTS   AGE</span>
<span class="err">web-0     1/1       Running   0          2h</span>
<span class="err">web-1     1/1       Running   0          2h</span>
<span class="err">NAME      READY     STATUS    RESTARTS   AGE</span>
<span class="err">web-2     0/1       Pending   0          0s</span>
<span class="err">web-2     0/1       Pending   0         0s</span>
<span class="err">web-2     0/1       ContainerCreating   0         0s</span>
<span class="err">web-2     1/1       Running   0         19s</span>
<span class="err">web-3     0/1       Pending   0         0s</span>
<span class="err">web-3     0/1       Pending   0         0s</span>
<span class="err">web-3     0/1       ContainerCreating   0         0s</span>
<span class="err">web-3     1/1       Running   0         18s</span>
<span class="err">web-4     0/1       Pending   0         0s</span>
<span class="err">web-4     0/1       Pending   0         0s</span>
<span class="err">web-4     0/1       ContainerCreating   0         0s</span>
<span class="err">web-4     1/1       Running   0         19s</span>
</code></pre></div>


<h3>Scaling down</h3>
<p>Use <code>kubectl patch</code> to scale the StatefulSet back down to three replicas. </p>
<div class="highlight"><pre><span></span><code>$ kubectl patch sts web -p <span class="s1">&#39;{&quot;spec&quot;:{&quot;replicas&quot;:3}}&#39;</span>
statefulset.apps/web patched
</code></pre></div>


<p>In temrinal 1, the process should show up. </p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl get pods -w -l app=nginx</span>
<span class="err">NAME      READY     STATUS              RESTARTS   AGE</span>
<span class="err">web-0     1/1       Running             0          3h</span>
<span class="err">web-1     1/1       Running             0          3h</span>
<span class="err">web-2     1/1       Running             0          55s</span>
<span class="err">web-3     1/1       Running             0          36s</span>
<span class="err">web-4     0/1       ContainerCreating   0          18s</span>
<span class="err">NAME      READY     STATUS    RESTARTS   AGE</span>
<span class="err">web-4     1/1       Running   0          19s</span>
<span class="err">web-4     1/1       Terminating   0         24s</span>
<span class="err">web-4     1/1       Terminating   0         24s</span>
<span class="err">web-3     1/1       Terminating   0         42s</span>
<span class="err">web-3     1/1       Terminating   0         42s</span>
</code></pre></div>


<p>But the <code>PersistenVolumes</code> mounted to the Pods are not deleted when the StatefulSet's Pods are deleted. This is true when Pod deletion is caused by scaling the StatefulSet down. </p>
<div class="highlight"><pre><span></span><code>$ kubectl get pvc -l <span class="nv">app</span><span class="o">=</span>nginx
NAME        STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE
www-web-0   Bound     pvc-15c268c7-b507-11e6-932f-42010a800002   1Gi        RWO           13h
www-web-1   Bound     pvc-15c79307-b507-11e6-932f-42010a800002   1Gi        RWO           13h
www-web-2   Bound     pvc-e1125b27-b508-11e6-932f-42010a800002   1Gi        RWO           13h
www-web-3   Bound     pvc-e1176df6-b508-11e6-932f-42010a800002   1Gi        RWO           13h
www-web-4   Bound     pvc-e11bb5f8-b508-11e6-932f-42010a800002   1Gi   
</code></pre></div>


<h2>Updating StatefulSets</h2>
<p>The update strategy is determined by the <code>spec.updateStrategy</code> field of the StatefulSet API object. This feature can be used to upgrade the container images, resource requests and/or limits, labels, and annotations of the Pods in a StatefulSet. There are two valid update strategies, <code>RollingUpdate</code> and <code>OnDelete</code>. <code>RollingUpdate</code> strategy is the default for StatefulSets. </p>
<h3>Rollin gupdate</h3>
<p><code>RollingUpdate</code> strategy update all Pods in a StatefulSet, in reverse ordinal order, while respecting the StatefulSet guarantees. </p>
<p>Patch the <code>web</code> StatefulSet to apply the strategy, </p>
<div class="highlight"><pre><span></span><code>$ kubectl patch statefulset web -p <span class="s1">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;type&quot;:&quot;RollingUpdate&quot;}}}&#39;</span>
statefulset.apps/web patched
</code></pre></div>


<p>In terminal 2, patch the <code>web</code> to change the container image. </p>
<div class="highlight"><pre><span></span><code>$ kubectl patch statefulset web --type<span class="o">=</span><span class="s1">&#39;json&#39;</span> -p<span class="o">=</span><span class="s1">&#39;[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/image&quot;, &quot;value&quot;:&quot;gcr.io/google_containers/nginx-slim:0.8&quot;}]&#39;</span>
statefulset.apps/web patched
</code></pre></div>


<p>In terminal 1, the process should be shown,</p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl get po -l app=nginx -w</span>
<span class="err">NAME      READY     STATUS    RESTARTS   AGE</span>
<span class="err">web-0     1/1       Running   0          7m</span>
<span class="err">web-1     1/1       Running   0          7m</span>
<span class="err">web-2     1/1       Running   0          8m</span>
<span class="err">web-2     1/1       Terminating   0         8m</span>
<span class="err">web-2     1/1       Terminating   0         8m</span>
<span class="err">web-2     0/1       Terminating   0         8m</span>
<span class="err">web-2     0/1       Terminating   0         8m</span>
<span class="err">web-2     0/1       Terminating   0         8m</span>
<span class="err">web-2     0/1       Terminating   0         8m</span>
<span class="err">web-2     0/1       Pending   0         0s</span>
<span class="err">web-2     0/1       Pending   0         0s</span>
<span class="err">web-2     0/1       ContainerCreating   0         0s</span>
<span class="err">web-2     1/1       Running   0         19s</span>
<span class="err">web-1     1/1       Terminating   0         8m</span>
<span class="err">web-1     0/1       Terminating   0         8m</span>
<span class="err">web-1     0/1       Terminating   0         8m</span>
<span class="err">web-1     0/1       Terminating   0         8m</span>
<span class="err">web-1     0/1       Pending   0         0s</span>
<span class="err">web-1     0/1       Pending   0         0s</span>
<span class="err">web-1     0/1       ContainerCreating   0         0s</span>
<span class="err">web-1     1/1       Running   0         6s</span>
<span class="err">web-0     1/1       Terminating   0         7m</span>
<span class="err">web-0     1/1       Terminating   0         7m</span>
<span class="err">web-0     0/1       Terminating   0         7m</span>
<span class="err">web-0     0/1       Terminating   0         7m</span>
<span class="err">web-0     0/1       Terminating   0         7m</span>
<span class="err">web-0     0/1       Terminating   0         7m</span>
<span class="err">web-0     0/1       Pending   0         0s</span>
<span class="err">web-0     0/1       Pending   0         0s</span>
<span class="err">web-0     0/1       ContainerCreating   0         0s</span>
<span class="err">web-0     1/1       Running   0         10s</span>
</code></pre></div>


<p>From the log, we can confirm that the Pods are updated in reverse ordinal order. The StatefulSet controller terminates each Pod, and waits for it to transition to Running and Ready prior to updating the next Pod. Note that, even though the StatefulSet controller will not proceed to update the next Pod until its ordinal successor is Running and Ready, it will restore any Pod that fails during the update to its current version. Pods that have already received the update will be restored to the updated version, and Pods that have not yet received the update will be restored to the previous version. In this way, the controller attempts to continue to keep the application healthy and the update consistent in the presence of intermittent failures. </p>
<p>Check the Pods' images:</p>
<div class="highlight"><pre><span></span><code><span class="x">for p in 0 1 2; do kubectl get po web-$p --template &#39;</span><span class="cp">{{</span><span class="nv">range</span> <span class="err">$</span><span class="nv">i</span><span class="o">,</span> <span class="err">$</span><span class="nv">c</span> <span class="o">:=</span> <span class="nv">.spec.containers</span><span class="cp">}}{{</span><span class="err">$</span><span class="nv">c.image</span><span class="cp">}}{{</span><span class="nv">end</span><span class="cp">}}</span><span class="x">&#39;; echo; done</span>
<span class="x">k8s.gcr.io/nginx-slim:0.8</span>
<span class="x">k8s.gcr.io/nginx-slim:0.8</span>
<span class="x">k8s.gcr.io/nginx-slim:0.8</span>
</code></pre></div>


<p><code>kubectl rollout status sts/&lt;name&gt;</code> can also view the status of a rolling update. </p>
<h3>Staging an update</h3>
<p>Staging an update can be achived by using the <code>partition</code> parameter of the <code>RollingUpdate</code> update strategy. It will keep all of the Pods in the StatefulSet at the current version while allowing mutation to the StatefulSet's <code>.spec.template</code>. </p>
<p>Use the following command to issue the patch. </p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl patch statefulset web -p &#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;type&quot;:&quot;RollingUpdate&quot;,&quot;rollingUpdate&quot;:{&quot;partition&quot;:3}}}}&#39;</span>
<span class="err">statefulset.apps/web patched</span>
</code></pre></div>


<p><code>"partition":3</code> covers the first 3 Pods in ordinal order. In this case web-2 is covered. </p>
<p>Change the container's image, </p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl patch statefulset web --type=&#39;json&#39; -p=&#39;[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/image&quot;, &quot;value&quot;:&quot;k8s.gcr.io/nginx-slim:0.7&quot;}]&#39;</span>
<span class="err">statefulset.apps/web patched</span>
</code></pre></div>


<p>Delete the Pod in the StatefulSet, </p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl delete po web-2</span>
<span class="err">pod &quot;web-2&quot; deleted</span>
</code></pre></div>


<p>Wait for StatefulSet to restart the Pod. Check the Pod's image again.</p>
<div class="highlight"><pre><span></span><code><span class="x">kubectl get po web-2 --template &#39;</span><span class="cp">{{</span><span class="nv">range</span> <span class="err">$</span><span class="nv">i</span><span class="o">,</span> <span class="err">$</span><span class="nv">c</span> <span class="o">:=</span> <span class="nv">.spec.containers</span><span class="cp">}}{{</span><span class="err">$</span><span class="nv">c.image</span><span class="cp">}}{{</span><span class="nv">end</span><span class="cp">}}</span><span class="x">&#39;</span>
<span class="x">k8s.gcr.io/nginx-slim:0.8</span>
</code></pre></div>


<p>Notice that it's still on version <code>0.8</code>. StatefulSet controller restored the Pod with its original container. This is because the ordinal of the Pod is less than the <code>partition</code> specified by the <code>updateStrategy</code>.</p>
<h3>Rolling out a Canary</h3>
<p>To roll out a canary to test, we can dcrementing the <code>partition</code> number. </p>
<div class="highlight"><pre><span></span><code>$ kubectl patch statefulset web -p <span class="s1">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;type&quot;:&quot;RollingUpdate&quot;,&quot;rollingUpdate&quot;:{&quot;partition&quot;:2}}}}&#39;</span>
statefulset.apps/web patched
</code></pre></div>


<p>This will cover <code>web-0</code> and <code>web-1</code>, <code>web-2</code> is no longer covered and will be restarted. Wait for <code>web-2</code> to be Running and Ready. </p>
<div class="highlight"><pre><span></span><code>$ kubectl get po -l <span class="nv">app</span><span class="o">=</span>nginx -w
NAME      READY     STATUS              RESTARTS   AGE
web-0     <span class="m">1</span>/1       Running             <span class="m">0</span>          4m
web-1     <span class="m">1</span>/1       Running             <span class="m">0</span>          4m
web-2     <span class="m">0</span>/1       ContainerCreating   <span class="m">0</span>          11s
web-2     <span class="m">1</span>/1       Running   <span class="m">0</span>         18s
</code></pre></div>


<p>Check the Pod's container, </p>
<div class="highlight"><pre><span></span><code><span class="x">kubectl get po web-2 --template &#39;</span><span class="cp">{{</span><span class="nv">range</span> <span class="err">$</span><span class="nv">i</span><span class="o">,</span> <span class="err">$</span><span class="nv">c</span> <span class="o">:=</span> <span class="nv">.spec.containers</span><span class="cp">}}{{</span><span class="err">$</span><span class="nv">c.image</span><span class="cp">}}{{</span><span class="nv">end</span><span class="cp">}}</span><span class="x">&#39;</span>
<span class="x">k8s.gcr.io/nginx-slim:0.7</span>
</code></pre></div>


<p>When you changed the <code>partition</code>, the StatefulSet controller automatically updated the <code>web-2</code> Pod because the Podâs ordinal was greater than or equal to the <code>partition</code>.</p>
<p>Verify <code>web-1</code> is still on version <code>0.8</code> by deleting it and wait for StatefulSet to restart it. </p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl delete po web-1</span>
<span class="err">pod &quot;web-1&quot; deleted</span>
</code></pre></div>


<p>Wait for <code>web-1</code> Pod to be Running and Ready, </p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl get po -l app=nginx -w</span>
<span class="err">NAME      READY     STATUS        RESTARTS   AGE</span>
<span class="err">web-0     1/1       Running       0          6m</span>
<span class="err">web-1     0/1       Terminating   0          6m</span>
<span class="err">web-2     1/1       Running       0          2m</span>
<span class="err">web-1     0/1       Terminating   0         6m</span>
<span class="err">web-1     0/1       Terminating   0         6m</span>
<span class="err">web-1     0/1       Terminating   0         6m</span>
<span class="err">web-1     0/1       Pending   0         0s</span>
<span class="err">web-1     0/1       Pending   0         0s</span>
<span class="err">web-1     0/1       ContainerCreating   0         0s</span>
<span class="err">web-1     1/1       Running   0         18s</span>
</code></pre></div>


<p>Check the image version, </p>
<div class="highlight"><pre><span></span><code><span class="x">kubectl get po web-1 --template &#39;</span><span class="cp">{{</span><span class="nv">range</span> <span class="err">$</span><span class="nv">i</span><span class="o">,</span> <span class="err">$</span><span class="nv">c</span> <span class="o">:=</span> <span class="nv">.spec.containers</span><span class="cp">}}{{</span><span class="err">$</span><span class="nv">c.image</span><span class="cp">}}{{</span><span class="nv">end</span><span class="cp">}}</span><span class="x">&#39;</span>
<span class="x">k8s.gcr.io/nginx-slim:0.8</span>
</code></pre></div>


<p><code>web-1</code> was restored to original configuration because the Pod's ordinal was less than the parition. All Pods with an ordinal that is greater than or equial to the partiion will be updated when the Statefulset's <code>.spec.template</code> is updated. </p>
<p>If a Pod that has an ordinal less than the partition is deleted or otherwise terminated, it will be restored to its original configuration.</p>
<h3>Phased roll outs</h3>
<p>Now that we've tesd the canary update on web-2, it's time to roll it out to all other Pods. The perform the phased roll out, update the <code>partition</code> to <code>0</code>. This means none of the Pods are covered under <code>partition</code>. </p>
<div class="highlight"><pre><span></span><code>$ kubectl patch statefulset web -p <span class="s1">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;type&quot;:&quot;RollingUpdate&quot;,&quot;rollingUpdate&quot;:{&quot;partition&quot;:0}}}}&#39;</span>
statefulset.apps/web patched
</code></pre></div>


<p>Wait for all Pods to be come Running and Ready. </p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl get po -l app=nginx -w</span>
<span class="err">NAME      READY     STATUS              RESTARTS   AGE</span>
<span class="err">web-0     1/1       Running             0          3m</span>
<span class="err">web-1     0/1       ContainerCreating   0          11s</span>
<span class="err">web-2     1/1       Running             0          2m</span>
<span class="err">web-1     1/1       Running   0         18s</span>
<span class="err">web-0     1/1       Terminating   0         3m</span>
<span class="err">web-0     1/1       Terminating   0         3m</span>
<span class="err">web-0     0/1       Terminating   0         3m</span>
<span class="err">web-0     0/1       Terminating   0         3m</span>
<span class="err">web-0     0/1       Terminating   0         3m</span>
<span class="err">web-0     0/1       Terminating   0         3m</span>
<span class="err">web-0     0/1       Pending   0         0s</span>
<span class="err">web-0     0/1       Pending   0         0s</span>
<span class="err">web-0     0/1       ContainerCreating   0         0s</span>
<span class="err">web-0     1/1       Running   0         3s</span>
</code></pre></div>


<p>Check Pod's container image versions. </p>
<div class="highlight"><pre><span></span><code><span class="x">for p in 0 1 2; do kubectl get po web-$p --template &#39;</span><span class="cp">{{</span><span class="nv">range</span> <span class="err">$</span><span class="nv">i</span><span class="o">,</span> <span class="err">$</span><span class="nv">c</span> <span class="o">:=</span> <span class="nv">.spec.containers</span><span class="cp">}}{{</span><span class="err">$</span><span class="nv">c.image</span><span class="cp">}}{{</span><span class="nv">end</span><span class="cp">}}</span><span class="x">&#39;; echo; done</span>
<span class="x">k8s.gcr.io/nginx-slim:0.7</span>
<span class="x">k8s.gcr.io/nginx-slim:0.7</span>
<span class="x">k8s.gcr.io/nginx-slim:0.7</span>
</code></pre></div>


<p>Now all Pods are updated. </p>
<h2>Deleting StatefulSets</h2>
<p>StatefulSet supports both Non-Cascading and Cascading deletion. In a Non-Cascading Delete, the StatefulSetâs Pods are not deleted when the StatefulSet is deleted. In a Cascading Delete, both the StatefulSet and its Pods are deleted.</p>
<h3>Non-Cascading Delete</h3>
<p>Use <code>kubectl delete</code> to delete the StatefulSet. Make sure to supply the <code>--cascade=false</code> paramter to the command. </p>
<div class="highlight"><pre><span></span><code>$ kubectl delete statefulset web --cascade<span class="o">=</span><span class="nb">false</span>
statefulset.apps <span class="s2">&quot;web&quot;</span> deleted
</code></pre></div>


<p>Get the Pods, </p>
<div class="highlight"><pre><span></span><code>$ kubectl get pods -l <span class="nv">app</span><span class="o">=</span>nginx
NAME      READY     STATUS    RESTARTS   AGE
web-0     <span class="m">1</span>/1       Running   <span class="m">0</span>          6m
web-1     <span class="m">1</span>/1       Running   <span class="m">0</span>          7m
web-2     <span class="m">1</span>/1       Running   <span class="m">0</span>          5m
</code></pre></div>


<p>All Pods are still running but they shouldn't be recreated if deleted as StatefulSet is deleted. </p>
<p>Delete the first Pod, </p>
<div class="highlight"><pre><span></span><code>$ kubectl delete pod web-0
pod <span class="s2">&quot;web-0&quot;</span> deleted
</code></pre></div>


<p>List the Pods, </p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl get pods -l app=nginx</span>
<span class="err">NAME      READY     STATUS    RESTARTS   AGE</span>
<span class="err">web-1     1/1       Running   0          10m</span>
<span class="err">web-2     1/1       Running   0          7m</span>
</code></pre></div>


<p><code>web-0</code> is removed for good. </p>
<p>Now let's restart the StatefulSet, </p>
<div class="highlight"><pre><span></span><code>$ kubectl create -f web.yaml 
statefulset.apps/web created
Error from server <span class="o">(</span>AlreadyExists<span class="o">)</span>: error when creating <span class="s2">&quot;web.yaml&quot;</span>: services <span class="s2">&quot;nginx&quot;</span> already exists
</code></pre></div>


<p>Examp the output of the <code>kubectl get</code>, </p>
<div class="highlight"><pre><span></span><code>$ kubectl get pods -w -l <span class="nv">app</span><span class="o">=</span>nginx
NAME      READY     STATUS    RESTARTS   AGE
web-1     <span class="m">1</span>/1       Running   <span class="m">0</span>          16m
web-2     <span class="m">1</span>/1       Running   <span class="m">0</span>          2m
NAME      READY     STATUS    RESTARTS   AGE
web-0     <span class="m">0</span>/1       Pending   <span class="m">0</span>          0s
web-0     <span class="m">0</span>/1       Pending   <span class="m">0</span>         0s
web-0     <span class="m">0</span>/1       ContainerCreating   <span class="m">0</span>         0s
web-0     <span class="m">1</span>/1       Running   <span class="m">0</span>         18s
web-2     <span class="m">1</span>/1       Terminating   <span class="m">0</span>         3m
web-2     <span class="m">0</span>/1       Terminating   <span class="m">0</span>         3m
web-2     <span class="m">0</span>/1       Terminating   <span class="m">0</span>         3m
web-2     <span class="m">0</span>/1       Terminating   <span class="m">0</span>         3m
</code></pre></div>


<p>The manifest requested replica of 2. <code>web-0</code> was removed before, thus recreated. <code>web-1</code> exists and is adopted. <code>web-2</code> is beyond the replica 2 and is terminated. </p>
<div class="highlight"><pre><span></span><code><span class="err">for i in 0 1; do kubectl exec -it web-$i -- curl localhost; done</span>
<span class="err">web-0</span>
<span class="err">web-1</span>
</code></pre></div>


<p>Notice the hostname in <code>index.html</code> still persists. </p>
<h3>Cascade delete</h3>
<p>Use the same delete command but without <code>--cascade=false</code>. </p>
<div class="highlight"><pre><span></span><code>$ kubectl delete statefulset web
statefulset.apps <span class="s2">&quot;web&quot;</span> deleted
</code></pre></div>


<p>Examp the output of <code>kubectl get pods -w -l app=nginx</code>, </p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl get pods -w -l app=nginx</span>
<span class="err">NAME      READY     STATUS    RESTARTS   AGE</span>
<span class="err">web-0     1/1       Running   0          11m</span>
<span class="err">web-1     1/1       Running   0          27m</span>
<span class="err">NAME      READY     STATUS        RESTARTS   AGE</span>
<span class="err">web-0     1/1       Terminating   0          12m</span>
<span class="err">web-1     1/1       Terminating   0         29m</span>
<span class="err">web-0     0/1       Terminating   0         12m</span>
<span class="err">web-0     0/1       Terminating   0         12m</span>
<span class="err">web-0     0/1       Terminating   0         12m</span>
<span class="err">web-1     0/1       Terminating   0         29m</span>
<span class="err">web-1     0/1       Terminating   0         29m</span>
<span class="err">web-1     0/1       Terminating   0         29m</span>
</code></pre></div>


<p>The Pods are deleted one at a time, with respect to the reverse order of their ordinal indices. </p>
<p>Note that, cascading delete will delete the StatefulSet and its Pods, it will not delete the headless Service associated with the StatefulSet. We need to delete the <code>nginx</code> Service manually. </p>
<div class="highlight"><pre><span></span><code>$ kubectl delete service nginx
service <span class="s2">&quot;nginx&quot;</span> deleted
</code></pre></div>


<h2>Pod management policy</h2>
<p>For some distributed systems, the StatefulSet ordering guarantees are unnecessary and/or undesierable. This can be changed using <code>.spec.podManagementPolicy</code> in the StatefulSet API object. </p>
<h3>OrderedReady Pod Management</h3>
<p><code>OrderedReady</code> pod management is the default for StatefulSets. It tells the StatefulSet controller to respect the ordering guarantees demonstrated above.</p>
<h3>Parallel Pod Management</h3>
<p><code>Parallel</code> pod management tells the StatefulSet controller to launch or terminate all Pods in parallel, and not to wait for Pods to become Running and Ready or completely terminated prior to launching or terminating another Pod.</p>
<p>For example, </p>
<div class="highlight"><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">ports</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">port</span><span class="o">:</span> <span class="mi">80</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
  <span class="n">clusterIP</span><span class="o">:</span> <span class="n">None</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
<span class="o">---</span>
<span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">StatefulSet</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">serviceName</span><span class="o">:</span> <span class="s2">&quot;nginx&quot;</span>
  <span class="n">podManagementPolicy</span><span class="o">:</span> <span class="s2">&quot;Parallel&quot;</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">k8s</span><span class="o">.</span><span class="na">gcr</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">slim</span><span class="o">:</span><span class="mf">0.8</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">www</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/usr/share/nginx/</span><span class="n">html</span>
  <span class="n">volumeClaimTemplates</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">metadata</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">www</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">accessModes</span><span class="o">:</span> <span class="o">[</span> <span class="s2">&quot;ReadWriteOnce&quot;</span> <span class="o">]</span>
      <span class="n">resources</span><span class="o">:</span>
        <span class="n">requests</span><span class="o">:</span>
          <span class="n">storage</span><span class="o">:</span> <span class="mi">1</span><span class="n">Gi</span>
</code></pre></div>


             
 
                <p id="post-share-links">
    Share on:
      <a href="https://twitter.com/intent/tweet?text=Kubernetes%20Stateful%20Application&url=https%3A//hazelement.github.io/kubernetes-stateful-application.html&hashtags=kubernetes,cicd" target="_blank" rel="nofollow noopener noreferrer" title="Share on Twitter">Twitter</a>
 â       <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//hazelement.github.io/kubernetes-stateful-application.html" target="_blank" rel="nofollow noopener noreferrer" title="Share on Facebook">Facebook</a>
 â       <a href="mailto:?subject=Kubernetes%20Stateful%20Application&amp;body=https%3A//hazelement.github.io/kubernetes-stateful-application.html" target="_blank" rel="nofollow noopener noreferrer" title="Share via Email">Email</a>

            
            







<section>
    <h6 style="display:none;">Comments</h6>
    <p id="comment-message"> </p>

    <div class="accordion" id="accordion2">
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle disqus-comment-count comment-count collapsed"
                   data-toggle="collapse"
                   data-parent="#accordion2"
                   data-disqus-identifier="./kubernetes-stateful-application.html"
                   href="./kubernetes-stateful-application.html#comment_thread"
                   id="comment-accordion-toggle">
                    Comments
                </a>
            </div>
            <div id="comment_thread" class="accordion-body collapse">
                <div class="accordion-inner">
                    <div class="comments">
                        <div id="disqus_thread"></div>
                        <script>
    var disqus_shortname = 'https-hazelement-github-io';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());

    var disqus_identifier = './kubernetes-stateful-application.html';
    var disqus_url = './kubernetes-stateful-application.html';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

            <hr/>
<section>
    <h2>Related Posts</h2>
<ul class="related-posts-list">
<li><a href="./kubernetes-basics.html" title="Kubernetes Basics">Kubernetes Basics</a></li>
<li><a href="./kubernetes-workflow.html" title="Kubernetes Workflow">Kubernetes Workflow</a></li>
<li><a href="./kubernetes-stateless-application.html" title="Kubernetes Stateless Application">Kubernetes Stateless Application</a></li>
<li><a href="./kubernetes-persistent-volume.html" title="Kubernetes Persistent Volume">Kubernetes Persistent Volume</a></li>
</ul>
<hr />
</section>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">Â« <a href="./kubernetes-stateless-application.html" title="Previous: Kubernetes Stateless Application">Kubernetes Stateless Application</a></li>
                <li class="next-article"><a href="./kubernetes-persistent-volume.html" title="Next: Kubernetes Persistent Volume">Kubernetes Persistent Volume</a> Â»</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2019-03-14T00:00:00-07:00">Thu 14 March 2019</time>
<h4>Last Updated</h4>
<time datetime="2019-03-15T00:00:00-07:00">Mar 15, 2019</time>

            <h4>Category</h4>
            <a class="category-link" href="./categories.html#kubernetes-ref">Kubernetes</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="./tags.html#cicd-ref">CI/CD
                    <span class="superscript">3</span>
</a></li>
                <li><a href="./tags.html#kubernetes-ref">Kubernetes
                    <span class="superscript">5</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/hazelement" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="./theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>